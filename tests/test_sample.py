import os
import sys
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..', 'src')))
from mlkem.auxiliaries import SampleNTT, PRF_eta, SamplePolyCBD_eta, NTT, NTT_inv
# from mlkem.internal_mlkem import INTERNAL_MLKEM_KeyGen, INTERNAL_MLKEM_Encaps, INTERNAL_MLKEM_Decaps
from mlkem.Internal_kpke import KPKE_KeyGen, KPKE_Encrypt, KPKE_Decrypt

print("Imported SampleNTT and PRF_eta successfully.\n")
print("Running tests... Using Rho and sigma from official test vectors.\n")
print("d: f688563f7c66a5da2d8bdb5a5f3e07bd8dce6f7efcec7f41298d79863459f7cd\n")
print("rho: 26ffff11b531b1800f4e1fa75c4d008c4f9a112932c669d543551204405da8b4\n")
print("sigma: 6de0c01beda8a2ba3f697c1bb8d5a46dc2ac63880c4f9b57db9f10534cef9a42\n")

d = bytes.fromhex("f688563f7c66a5da2d8bdb5a5f3e07bd8dce6f7efcec7f41298d79863459f7cd")
rho = bytes.fromhex("26ffff11b531b1800f4e1fa75c4d008c4f9a112932c669d543551204405da8b4")
sigma = bytes.fromhex("6de0c01beda8a2ba3f697c1bb8d5a46dc2ac63880c4f9b57db9f10534cef9a42")

print("Testing SampleNTT")
# Testing SampleNTT
expected_SampleNTT = {1413, 10, 604, 2877, 3203, 1546, 1604, 1174, 616, 1275, 2938, 394, 1529, 420, 397, 2532, 619, 1129, 2868, 294, 2356, 2288, 1330, 2649, 2530, 1123, 2119, 3163, 1542, 2725, 1282, 2023, 3308, 1299, 1987, 2334, 726, 3141, 3114, 1371, 667, 1415, 99, 2891, 2749, 1816, 584, 2813, 1463, 459, 1848, 185, 1602, 2052, 3209, 3220, 495, 851, 905, 3314, 2542, 658, 1122, 1500, 663, 1044, 493, 1593, 1541, 3202, 836, 2236, 281, 829, 2078, 517, 168, 2997, 845, 383, 432, 2232, 3267, 324, 1024, 1450, 2805, 1484, 1362, 39, 956, 974, 2289, 1780, 3227, 2180, 619, 1941, 3313, 267, 2992, 1172, 3292, 2044, 1272, 821, 2785, 697, 2584, 2497, 1377, 3075, 3040, 1149, 2763, 1577, 142, 1624, 1186, 2703, 166, 1986, 2618, 3051, 1146, 402, 2003, 1391, 585, 1617, 646, 2176, 3262, 1603, 1543, 2426, 2188, 1624, 1727, 2735, 335, 2465, 1106, 803, 2364, 500, 31, 219, 1922, 126, 917, 1821, 3033, 699, 1866, 2205, 1098, 3229, 2689, 1060, 3256, 1558, 1545, 3206, 678, 672, 1430, 1052, 2905, 3299, 612, 1960, 2661, 2527, 2546, 2593, 3153, 3168, 922, 2152, 528, 3076, 746, 3246, 1601, 779, 2135, 2877, 1892, 946, 2771, 354, 3081, 2793, 3314, 1840, 822, 3124, 2778, 2066, 3188, 2553, 125, 413, 2694, 2297, 456, 1415, 40, 1073, 51, 476, 1759, 752, 1244, 3141, 1886, 1189, 1274, 2352, 514, 1853, 2527, 3161, 1094, 3105, 1794, 1454, 1970, 2704, 2253, 983, 68, 669, 766, 2535, 259, 348, 2019, 3290, 3261, 1379, 3102, 1277, 401, 110, 2539, 1702, 588, 2866, 1895, 1203, 1371, 239, 2622, 2237}
i = 0
j = 0
B = rho + bytes([i]) + bytes([j])
out = SampleNTT(B)
# print("SampleNTT output:", set(out))
# print("Expected output:", expected)
assert set(out) == expected_SampleNTT, f"SampleNTT output does not match expected output for i={i}, j={j}"
print("SampleNTT test passed.\n")

print("Testing SamplePolyCBD_eta")
eta = 2
nonce = 0
buf = PRF_eta(eta, sigma, bytes([nonce]))

expected_PolyCBD = {3328, 0, 0, 3328, 3328, 3328, 1, 0, 0, 0, 1, 2, 1, 1, 0, 3328, 0, 3328, 0, 2, 0, 0, 1, 0, 2, 0, 0, 1, 1, 0, 3328, 0, 1, 0, 1, 0, 3328, 1, 1, 0, 0, 3328, 3328, 0, 3328, 3328, 1, 3327, 1, 0, 3328, 0, 3328, 1, 3328, 1, 2, 2, 0, 3328, 2, 0, 0, 0, 3328, 3328, 0, 0, 0, 0, 1, 1, 3327, 1, 1, 0, 3328, 1, 0, 1, 3328, 3328, 0, 1, 3328, 1, 3328, 1, 0, 0, 1, 3328, 1, 0, 0, 0, 0, 3328, 3328, 1, 0, 0, 2, 0, 0, 1, 0, 3328, 3328, 0, 3328, 1, 1, 3328, 3328, 3327, 3328, 0, 3327, 0, 0, 0, 1, 0, 3328, 2, 1, 3328, 0, 3328, 1, 0, 1, 0, 3328, 3328, 1, 1, 3328, 1, 1, 1, 0, 0, 0, 0, 3328, 3328, 0, 3328, 3328, 1, 0, 0, 0, 0, 0, 0, 3327, 1, 3328, 0, 1, 1, 0, 3328, 3328, 1, 3328, 3328, 1, 0, 1, 2, 3328, 0, 1, 3328, 3328, 0, 1, 0, 3328, 0, 0, 1, 1, 0, 0, 1, 1, 0, 3328, 0, 1, 0, 1, 1, 3328, 0, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 3327, 3327, 1, 0, 1, 0, 0, 3328, 3328, 3328, 3327, 1, 3328, 0, 0, 0, 2, 1, 2, 0, 0, 3328, 1, 1, 0, 0, 3328, 3328, 0, 1, 1, 3328, 3328, 0, 3328, 0, 1, 1, 0, 0, 2, 1, 3328, 0, 0, 1}
poly = SamplePolyCBD_eta(buf, eta)
assert len(poly) == 256
assert set(poly) == expected_PolyCBD, "SamplePolyCBD_eta output does not match expected output"

print("SamplePolyCBD_eta test passed\n")

print("Testing NTT and NTT_inv round-trip")
# Testing NTT and NTT_inv round-trip
poly = poly  # from previous test
expected_NTT = {306, 1942, 1038, 2121, 1478, 852, 1794, 2263, 2789, 3279, 1516, 1756, 2964, 3007, 2621, 54, 925, 3296, 2999, 592, 2639, 514, 282, 2345, 2485, 649, 2949, 1742, 1183, 2964, 187, 3159, 3204, 1164, 2193, 743, 2631, 2636, 3090, 2740, 1645, 1787, 3182, 2826, 3226, 1758, 1388, 815, 590, 717, 2812, 962, 1699, 2774, 61, 2826, 185, 2731, 1818, 3086, 1916, 1897, 711, 1855, 2124, 2626, 1445, 1911, 2615, 2600, 2743, 1183, 2532, 2696, 759, 3210, 1549, 227, 2658, 930, 2113, 241, 1713, 2017, 854, 1013, 1011, 2574, 1283, 150, 1035, 1368, 2071, 2400, 3220, 2038, 3049, 261, 268, 1901, 3263, 1091, 3117, 2406, 1256, 2973, 2454, 2058, 470, 2599, 3136, 342, 1704, 3234, 2226, 856, 2716, 703, 1370, 2051, 3061, 1371, 1668, 3211, 3292, 1291, 1828, 332, 3231, 1419, 2063, 464, 2978, 1854, 3226, 1377, 2314, 2835, 209, 699, 1813, 783, 510, 799, 2389, 1112, 348, 1002, 2356, 1312, 1642, 1029, 755, 1033, 2192, 1733, 2045, 1731, 1825, 1459, 887, 182, 2686, 2736, 3292, 2072, 1566, 1221, 1393, 341, 394, 1228, 2559, 2280, 486, 2802, 1420, 3312, 3277, 3138, 795, 1054, 2081, 389, 1510, 2622, 1660, 1953, 2872, 2577, 1732, 1402, 1572, 1247, 2729, 3076, 878, 213, 550, 656, 3259, 1554, 417, 1901, 2608, 954, 2623, 2628, 2977, 2045, 2932, 2800, 2749, 2985, 2369, 244, 1561, 299, 2941, 1631, 28, 802, 305, 567, 2150, 770, 2758, 2974, 3053, 1140, 3075, 775, 1189, 77, 1678, 2522, 1761, 2359, 2083, 1402, 1574, 1575, 2167, 602, 84, 204, 1523, 11, 2550, 2986, 2823, 1760, 286, 240, 2022, 1062}
f = SamplePolyCBD_eta(buf, eta)
f_hat = NTT(f)
assert len(f_hat) == 256
assert set(f_hat) == expected_NTT

print("NTT test passed")
f_rec = NTT_inv(f_hat)
assert f_rec == [x % 3329 for x in f]
print("NTT_inv round-trip test passed")

# print("Testing keygen")
# dk, ek = KPKE_KeyGen(d,256,2)
# expected_dk_hex = "3261790e9484c6453502778de5faccecc56d94fbbb3d6a039d03ceb70b254f2a201a9192b5992885eb6c9f44b9bb70c584cc4891782e47caa4124cab6db66f6eacb09aec6d6cf5324ed22cfc2a3ca366ad3da0b0b9b0aa1ae7c07c9776c7f2734c28a4a57577378aa2b7fa49e489a8f7a2c80d360e622a3a41180fb1167e56533ff3e3a00365090b8455170896946c7fe95b100cd176bf3c442d6c96e8d4b996a980d671a2406c15a826cab288359cfa2b5a3580f5bb5584b6c8dcbc5024c7149fbc580f081da2eb739a1c560a39b1d1b02b15f730fef1315589455ca13e3409526a5640f3924090586cfd376c21375b77630b7e0aabdc8c811e564c7155158ac14cff898ee621af8c05cfcd2cc41be341215818e6e5a37c167a381ba1c4a65724f64da94ac06e530d260229bb2c61a1d17630aa3b3f4aa4a1db7f740bafbd9aba41490f19b6127dfb651c2032317123662830c6eab9ed4b47037c30a5d4048ea69de1769323a85726766277a82554c00cf3b500f6a9ba070b6e1e010fe667429d5259d027ccaaec559c760ae99b62c014cf76b08c89a72d3e233af5251976e288da3a8fa2820e6ca8ca953ab8f504060fd2c0104558af67c34691c1c4c2878d5904c94390b1639548e206659804a3759a6a7930921a3fc2853d8e90cd94b523fe1a30704030f04b9d4fc919fd22c27966aa53180916009e3f831a47b53f5951087d110c010cb81a415d88c3cb19031e3f30a21496903f59ce75742227b22ca7687ad3b05c0aca42e3747bc5fb1683b796a10bac6a158a745836478829707b70aca820d3a9b6adda8091bc0c44c9bca1f57bae60165940ac87815c1e36a783a88b2b68655d22ccebd1490d4440a00775dd1a68f0d3125c7cb48d8a91db2993542c5541137e817206705bb23a261eb3740d952b1af92181f8a629e156b7a6d703d9225706a5bee26845bd80552df9a620f16b4c1444ed2514ec8c2aed453bedb9805174ada9610c91aca500ccb221c109a56377bfc043fc0410340c0d4a509be7d1252d65af888905ad42bfd9cc0e84b63d82032de9cb1cc1264fb6b65c2304818c566fdb36c47e43b3e43b405f7b8944340f78830901507d145b1818c86d9b003d03e5a33310ca66c44d63b2bdb427cc0dd68fd32176292359ce639c9177454e6a36d7cb808e13a9d309310b455202ec6bcf2891d2590755b92e4f0354e766b049d77b4b5cbd8b332a6d1261cc58a384ebb842d92273202eb7b45570cc42fb039c18b4a1308062d6710601c209f5b425d3a6b8735911fdb6bb26a556595c5e69d66a5fc346552526d8a8a292b3cda869b28fab0b2cb6162e583e8c9c558c4c8c457cb83e67c2f03960011091fdf5a35b88712d3aa5e0d0961242653850acca27be2a8523b0557dc38a3fd90acddb190c813c3e86d50e2dac874f2316c607a3582aacef1c14dee409551a9e02f60e9737c9940799b39932cd645341444414c77f4fa9046ee4020fb68d607b46759615803572502a296c291965b2c92320c663d504e06a0bce3286a854c74a6256e168c0b750805359986493a25f75b5f8923bbbd4b2a30b6e9092ce0a5035939c47e900c4235a447796a426713e1bd269a13493"
# expected_ek_hex = "d0f1a25721155a28143a355f99c582c2d258a270b9f78941af004116e94f2f9825af17c50b600705ea1a9c2440df6803518a5ba558acb5b732d06a3c80e555fa374d80d82f08c5b47ca12cbe6520340538c2100b5e094392acacafe1ce4ad74fa451c4379219140103e9c3ba7ba683cddca0d3b02d57104c292b2e25bc791d8b11d5079477d7b0f930176fb0a5cda99afbfb6fca86226cb8152b250a536ca60b6ccf93880007068b41bbc5c6e9b8bd92af8a717e37c69ac7db7e76a2c36eb028c1e098915274b4d59def6c42d3c25bb35310846809c96bc43b639e52a3730654cc8db548faf21e446ca874a3caba777bac25b56902481c79a744d70d12130ad6bc8136349e3234c556267e97b0a8ccf772528299fa26111172c223f2484102917bdb6de7770682698763e5b2038779f812363a727f40949b76b6913c8910d6f51dd48983ba149c070590582662fbc9053b667e1eea1ca7173e421576f2d8ad7bf415899484bd1530b4fc855354952cf28d0f1216dfba00ec100bdd76c4f4b405c913baa78958ae31c578463877138cf89255a3935cfbd1b77dbb5f66b87543131da4aabb6781427f417e841141dcb47fcd82a92aeb3c50030d71eb7f3b17b0207a6cdf654d563a420bb742ac30c0e01235910886ff045652d5035b7ab98a1b6abac88ea5996b965c2d3f3305e075bbca267e8547c6c7769fb9f91e20849b524b7822965fe036a515c60e24636a3665b23b878c5b7658f7c49f2059255c89536426510875cbdca111bdc29183459340c125df30c05a7698490193d88c52410a14a7f12a118495413487b434568d105f2d7b9c0fc32e80a13e142528ca1825e0830cd41071aac7124042145be35e30d541c2ba31a82a5f479b3bad881164aa347386c9bfa505c9968fdea866120c8b4e809bdb1482d790a03fcb1ca88c15aae8047e1678ba66833ca430d592638bf3be19592027b3ccb044a9a4d01f3804c2fe0ca60cc7c017dc14dff60562f20d912650fc24449a78998d2b0ce4d9b131955affe7b5c12278cb5b23847c8090fc0578f71760918e9ee8274673845ca29f8d338fa89637265c518f902a9ba8ad9615764ce9835b322e0b5bb1fe928888318988e435cc3c3a918ccc773371a9687884f0822558ae634a54d7c74556528f2d7cb212f1901a82ae68905330b4550518b7b44c117f335f9c818635a2a29e59b39784b021d88354d707cfe0b3599b54fa4a1218261dc72a00cf2ccef8c6c2fe131899f9a239f545c4605296d7b39beb0832732eb608464df29d193b2f2c3b7c69cbbc2082cda14863071235a75544320c1c7930262f82ac7ba788c6c09586c2420d7385a0a6c50d050910e2956844b558fa78b6cb2969e866a0bcc1b7b980a02669c226b6c9267f6e66995d6b37eedc8e34f516ef48a69a3461f3742cc6268b26a8c158e4bf34c072d4e37a4e273ee3464aea81b57c52ab4d5a1e94a668c9a14612196f6a792646581a8ff545179323aaa8369c21181c1329464099cdf940fa56ce1f204ad4b048d5e783e1948b3493b273b2a33d8c0183e386786c7e7e421b1536610cecb16b7a98641b95693879a7d8bc444931cedaa6c45303aac0a48ac29041085526ffff11b531b1800f4e1fa75c4d008c4f9a112932c669d543551204405da8b4"
# assert dk.hex() == expected_dk_hex, "Keygen dk does not match expected value"
# assert ek.hex() == expected_ek_hex, "Keygen ek does not match expected value"
# print("Keygen test passed\n")

print("\nAll tests passed successfully.")