import os
import sys
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..', 'src')))
from mlkem.auxiliaries import SampleNTT, PRF_eta, SamplePolyCBD_eta, NTT, NTT_inv, G, ByteEncode_d, ByteDecode_d
from mlkem.internal_mlkem import INTERNAL_MLKEM_KeyGen, INTERNAL_MLKEM_Encaps, INTERNAL_MLKEM_Decaps
from mlkem.Internal_kpke import KPKE_KeyGen, KPKE_Encrypt, KPKE_Decrypt

class MLKEM768:
    k = 3
    eta1 = 2
    eta2 = 2
    q = 3329  # Constant for all ML-KEM sets
    n = 256
    du = 10
    dv = 4

print("Imported SampleNTT and PRF_eta successfully.\n")
print("Running tests... Using Rho and sigma from official test vectors.\n")
print("d: f688563f7c66a5da2d8bdb5a5f3e07bd8dce6f7efcec7f41298d79863459f7cd\n")
print("rho: 26ffff11b531b1800f4e1fa75c4d008c4f9a112932c669d543551204405da8b4\n")
print("sigma: 6de0c01beda8a2ba3f697c1bb8d5a46dc2ac63880c4f9b57db9f10534cef9a42\n")

d = bytes.fromhex("f688563f7c66a5da2d8bdb5a5f3e07bd8dce6f7efcec7f41298d79863459f7cd")
rho = bytes.fromhex("26ffff11b531b1800f4e1fa75c4d008c4f9a112932c669d543551204405da8b4")
sigma = bytes.fromhex("6de0c01beda8a2ba3f697c1bb8d5a46dc2ac63880c4f9b57db9f10534cef9a42")
ek_vector = bytes.fromhex("d0f1a25721155a28143a355f99c582c2d258a270b9f78941af004116e94f2f9825af17c50b600705ea1a9c2440df6803518a5ba558acb5b732d06a3c80e555fa374d80d82f08c5b47ca12cbe6520340538c2100b5e094392acacafe1ce4ad74fa451c4379219140103e9c3ba7ba683cddca0d3b02d57104c292b2e25bc791d8b11d5079477d7b0f930176fb0a5cda99afbfb6fca86226cb8152b250a536ca60b6ccf93880007068b41bbc5c6e9b8bd92af8a717e37c69ac7db7e76a2c36eb028c1e098915274b4d59def6c42d3c25bb35310846809c96bc43b639e52a3730654cc8db548faf21e446ca874a3caba777bac25b56902481c79a744d70d12130ad6bc8136349e3234c556267e97b0a8ccf772528299fa26111172c223f2484102917bdb6de7770682698763e5b2038779f812363a727f40949b76b6913c8910d6f51dd48983ba149c070590582662fbc9053b667e1eea1ca7173e421576f2d8ad7bf415899484bd1530b4fc855354952cf28d0f1216dfba00ec100bdd76c4f4b405c913baa78958ae31c578463877138cf89255a3935cfbd1b77dbb5f66b87543131da4aabb6781427f417e841141dcb47fcd82a92aeb3c50030d71eb7f3b17b0207a6cdf654d563a420bb742ac30c0e01235910886ff045652d5035b7ab98a1b6abac88ea5996b965c2d3f3305e075bbca267e8547c6c7769fb9f91e20849b524b7822965fe036a515c60e24636a3665b23b878c5b7658f7c49f2059255c89536426510875cbdca111bdc29183459340c125df30c05a7698490193d88c52410a14a7f12a118495413487b434568d105f2d7b9c0fc32e80a13e142528ca1825e0830cd41071aac7124042145be35e30d541c2ba31a82a5f479b3bad881164aa347386c9bfa505c9968fdea866120c8b4e809bdb1482d790a03fcb1ca88c15aae8047e1678ba66833ca430d592638bf3be19592027b3ccb044a9a4d01f3804c2fe0ca60cc7c017dc14dff60562f20d912650fc24449a78998d2b0ce4d9b131955affe7b5c12278cb5b23847c8090fc0578f71760918e9ee8274673845ca29f8d338fa89637265c518f902a9ba8ad9615764ce9835b322e0b5bb1fe928888318988e435cc3c3a918ccc773371a9687884f0822558ae634a54d7c74556528f2d7cb212f1901a82ae68905330b4550518b7b44c117f335f9c818635a2a29e59b39784b021d88354d707cfe0b3599b54fa4a1218261dc72a00cf2ccef8c6c2fe131899f9a239f545c4605296d7b39beb0832732eb608464df29d193b2f2c3b7c69cbbc2082cda14863071235a75544320c1c7930262f82ac7ba788c6c09586c2420d7385a0a6c50d050910e2956844b558fa78b6cb2969e866a0bcc1b7b980a02669c226b6c9267f6e66995d6b37eedc8e34f516ef48a69a3461f3742cc6268b26a8c158e4bf34c072d4e37a4e273ee3464aea81b57c52ab4d5a1e94a668c9a14612196f6a792646581a8ff545179323aaa8369c21181c1329464099cdf940fa56ce1f204ad4b048d5e783e1948b3493b273b2a33d8c0183e386786c7e7e421b1536610cecb16b7a98641b95693879a7d8bc444931cedaa6c45303aac0a48ac29041085526ffff11b531b1800f4e1fa75c4d008c4f9a112932c669d543551204405da8b4")
m_test = bytes.fromhex("3dc27ca0a6594b0e56320457c45a0f76bb8a213ea4a76d442186a0aefadbcdb9")
K_test = bytes.fromhex("4b4eba37eff0315dc6009dcffb4dfbbb680f8f2ebde8715fa3d6daf70256a2d9")
r_test = bytes.fromhex("c52fc55f9edb30bda71bb983e058bc111b227dc3c853b66caa5fcb7f32e69b57")
rho_actual, sigma_actual = G(d + bytes([3]))
print("rho :  ", rho_actual.hex())
print("sigma :", sigma_actual.hex())
print(f"{'Variable':<15} | {'Test Vector (Hex)':<30} | {'Your Output (Hex)':<30}")
print("-" * 80)
print(f"{'d':<15} | {d.hex()[:27]}... | {d.hex()[:27]}...")
print(f"{'rho (Ï)':<15} | {rho.hex()[:27]}... | {rho.hex()[:27]}...")

expected_SampleNTT = [1413, 10, 604, 2877, 3203, 1546, 1604, 1174, 616, 1275, 2938, 394, 1529, 420, 397, 2532, 619, 1129, 2868, 294, 2356, 2288, 1330, 2649, 2530, 1123, 2119, 3163, 1542, 2725, 1282, 2023, 3308, 1299, 1987, 2334, 726, 3141, 3114, 1371, 667, 1415, 99, 2891, 2749, 1816, 584, 2813, 1463, 459, 1848, 185, 1602, 2052, 3209, 3220, 495, 851, 905, 3314, 2542, 658, 1122, 1500, 663, 1044, 493, 1593, 1541, 3202, 836, 2236, 281, 829, 2078, 517, 168, 2997, 845, 383, 432, 2232, 3267, 324, 1024, 1450, 2805, 1484, 1362, 39, 956, 974, 2289, 1780, 3227, 2180, 619, 1941, 3313, 267, 2992, 1172, 3292, 2044, 1272, 821, 2785, 697, 2584, 2497, 1377, 3075, 3040, 1149, 2763, 1577, 142, 1624, 1186, 2703, 166, 1986, 2618, 3051, 1146, 402, 2003, 1391, 585, 1617, 646, 2176, 3262, 1603, 1543, 2426, 2188, 1624, 1727, 2735, 335, 2465, 1106, 803, 2364, 500, 31, 219, 1922, 126, 917, 1821, 3033, 699, 1866, 2205, 1098, 3229, 2689, 1060, 3256, 1558, 1545, 3206, 678, 672, 1430, 1052, 2905, 3299, 612, 1960, 2661, 2527, 2546, 2593, 3153, 3168, 922, 2152, 528, 3076, 746, 3246, 1601, 779, 2135, 2877, 1892, 946, 2771, 354, 3081, 2793, 3314, 1840, 822, 3124, 2778, 2066, 3188, 2553, 125, 413, 2694, 2297, 456, 1415, 40, 1073, 51, 476, 1759, 752, 1244, 3141, 1886, 1189, 1274, 2352, 514, 1853, 2527, 3161, 1094, 3105, 1794, 1454, 1970, 2704, 2253, 983, 68, 669, 766, 2535, 259, 348, 2019, 3290, 3261, 1379, 3102, 1277, 401, 110, 2539, 1702, 588, 2866, 1895, 1203, 1371, 239, 2622, 2237]
a_hat = SampleNTT(rho + bytes([0]) + bytes([0]))

assert a_hat == expected_SampleNTT, f"SampleNTT output does not match expected output"

expected_PolyCBD_s_hat = [3328, 0, 0, 3328, 3328, 3328, 1, 0, 0, 0, 1, 2, 1, 1, 0, 3328, 0, 3328, 0, 2, 0, 0, 1, 0, 2, 0, 0, 1, 1, 0, 3328, 0, 1, 0, 1, 0, 3328, 1, 1, 0, 0, 3328, 3328, 0, 3328, 3328, 1, 3327, 1, 0, 3328, 0, 3328, 1, 3328, 1, 2, 2, 0, 3328, 2, 0, 0, 0, 3328, 3328, 0, 0, 0, 0, 1, 1, 3327, 1, 1, 0, 3328, 1, 0, 1, 3328, 3328, 0, 1, 3328, 1, 3328, 1, 0, 0, 1, 3328, 1, 0, 0, 0, 0, 3328, 3328, 1, 0, 0, 2, 0, 0, 1, 0, 3328, 3328, 0, 3328, 1, 1, 3328, 3328, 3327, 3328, 0, 3327, 0, 0, 0, 1, 0, 3328, 2, 1, 3328, 0, 3328, 1, 0, 1, 0, 3328, 3328, 1, 1, 3328, 1, 1, 1, 0, 0, 0, 0, 3328, 3328, 0, 3328, 3328, 1, 0, 0, 0, 0, 0, 0, 3327, 1, 3328, 0, 1, 1, 0, 3328, 3328, 1, 3328, 3328, 1, 0, 1, 2, 3328, 0, 1, 3328, 3328, 0, 1, 0, 3328, 0, 0, 1, 1, 0, 0, 1, 1, 0, 3328, 0, 1, 0, 1, 1, 3328, 0, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 3327, 3327, 1, 0, 1, 0, 0, 3328, 3328, 3328, 3327, 1, 3328, 0, 0, 0, 2, 1, 2, 0, 0, 3328, 1, 1, 0, 0, 3328, 3328, 0, 1, 1, 3328, 3328, 0, 3328, 0, 1, 1, 0, 0, 2, 1, 3328, 0, 0, 1]
assert SamplePolyCBD_eta(PRF_eta(2, sigma, bytes([0])), 2) == expected_PolyCBD_s_hat, "SamplePolyCBD_eta output does not match expected output"
print(f"{'s[0]':<15} | {list(expected_PolyCBD_s_hat)[:6]}... |{SamplePolyCBD_eta(PRF_eta(2, sigma, bytes([0])), 2)[:6]}...")

expected_NTT =[306, 1942, 1038, 2121, 1478, 852, 1794, 2263, 2789, 3279, 1516, 1756, 2964, 3007, 2621, 54, 925, 3296, 2999, 592, 2639, 514, 282, 2345, 2485, 649, 2949, 1742, 1183, 2964, 187, 3159, 3204, 1164, 2193, 743, 2631, 2636, 3090, 2740, 1645, 1787, 3182, 2826, 3226, 1758, 1388, 815, 590, 717, 2812, 962, 1699, 2774, 61, 2826, 185, 2731, 1818, 3086, 1916, 1897, 711, 1855, 2124, 2626, 1445, 1911, 2615, 2600, 2743, 1183, 2532, 2696, 759, 3210, 1549, 227, 2658, 930, 2113, 241, 1713, 2017, 854, 1013, 1011, 2574, 1283, 150, 1035, 1368, 2071, 2400, 3220, 2038, 3049, 261, 268, 1901, 3263, 1091, 3117, 2406, 1256, 2973, 2454, 2058, 470, 2599, 3136, 342, 1704, 3234, 2226, 856, 2716, 703, 1370, 2051, 3061, 1371, 1668, 3211, 3292, 1291, 1828, 332, 3231, 1419, 2063, 464, 2978, 1854, 3226, 1377, 2314, 2835, 209, 699, 1813, 783, 510, 799, 2389, 1112, 348, 1002, 2356, 1312, 1642, 1029, 755, 1033, 2192, 1733, 2045, 1731, 1825, 1459, 887, 182, 2686, 2736, 3292, 2072, 1566, 1221, 1393, 341, 394, 1228, 2559, 2280, 486, 2802, 1420, 3312, 3277, 3138, 795, 1054, 2081, 389, 1510, 2622, 1660, 1953, 2872, 2577, 1732, 1402, 1572, 1247, 2729, 3076, 878, 213, 550, 656, 3259, 1554, 417, 1901, 2608, 954, 2623, 2628, 2977, 2045, 2932, 2800, 2749, 2985, 2369, 244, 1561, 299, 2941, 1631, 28, 802, 305, 567, 2150, 770, 2758, 2974, 3053, 1140, 3075, 775, 1189, 77, 1678, 2522, 1761, 2359, 2083, 1402, 1574, 1575, 2167, 602, 84, 204, 1523, 11, 2550, 2986, 2823, 1760, 286, 240, 2022, 1062]
s_hat = NTT(SamplePolyCBD_eta(PRF_eta(2, sigma, bytes([0])), 2))
print(f"{'s_hat[0]':<15} | {s_hat[:6]}... | {expected_NTT[:6]} ...")
DKPKE = "3261790e9484c6453502778de5faccecc56d94fbbb3d6a039d03ceb70b254f2a201a9192b5992885eb6c9f44b9bb70c584cc4891782e47caa4124cab6db66f6eacb09aec6d6cf5324ed22cfc2a3ca366ad3da0b0b9b0aa1ae7c07c9776c7f2734c28a4a57577378aa2b7fa49e489a8f7a2c80d360e622a3a41180fb1167e56533ff3e3a00365090b8455170896946c7fe95b100cd176bf3c442d6c96e8d4b996a980d671a2406c15a826cab288359cfa2b5a3580f5bb5584b6c8dcbc5024c7149fbc580f081da2eb739a1c560a39b1d1b02b15f730fef1315589455ca13e3409526a5640f3924090586cfd376c21375b77630b7e0aabdc8c811e564c7155158ac14cff898ee621af8c05cfcd2cc41be341215818e6e5a37c167a381ba1c4a65724f64da94ac06e530d260229bb2c61a1d17630aa3b3f4aa4a1db7f740bafbd9aba41490f19b6127dfb651c2032317123662830c6eab9ed4b47037c30a5d4048ea69de1769323a85726766277a82554c00cf3b500f6a9ba070b6e1e010fe667429d5259d027ccaaec559c760ae99b62c014cf76b08c89a72d3e233af5251976e288da3a8fa2820e6ca8ca953ab8f504060fd2c0104558af67c34691c1c4c2878d5904c94390b1639548e206659804a3759a6a7930921a3fc2853d8e90cd94b523fe1a30704030f04b9d4fc919fd22c27966aa53180916009e3f831a47b53f5951087d110c010cb81a415d88c3cb19031e3f30a21496903f59ce75742227b22ca7687ad3b05c0aca42e3747bc5fb1683b796a10bac6a158a745836478829707b70aca820d3a9b6adda8091bc0c44c9bca1f57bae60165940ac87815c1e36a783a88b2b68655d22ccebd1490d4440a00775dd1a68f0d3125c7cb48d8a91db2993542c5541137e817206705bb23a261eb3740d952b1af92181f8a629e156b7a6d703d9225706a5bee26845bd80552df9a620f16b4c1444ed2514ec8c2aed453bedb9805174ada9610c91aca500ccb221c109a56377bfc043fc0410340c0d4a509be7d1252d65af888905ad42bfd9cc0e84b63d82032de9cb1cc1264fb6b65c2304818c566fdb36c47e43b3e43b405f7b8944340f78830901507d145b1818c86d9b003d03e5a33310ca66c44d63b2bdb427cc0dd68fd32176292359ce639c9177454e6a36d7cb808e13a9d309310b455202ec6bcf2891d2590755b92e4f0354e766b049d77b4b5cbd8b332a6d1261cc58a384ebb842d92273202eb7b45570cc42fb039c18b4a1308062d6710601c209f5b425d3a6b8735911fdb6bb26a556595c5e69d66a5fc346552526d8a8a292b3cda869b28fab0b2cb6162e583e8c9c558c4c8c457cb83e67c2f03960011091fdf5a35b88712d3aa5e0d0961242653850acca27be2a8523b0557dc38a3fd90acddb190c813c3e86d50e2dac874f2316c607a3582aacef1c14dee409551a9e02f60e9737c9940799b39932cd645341444414c77f4fa9046ee4020fb68d607b46759615803572502a296c291965b2c92320c663d504e06a0bce3286a854c74a6256e168c0b750805359986493a25f75b5f8923bbbd4b2a30b6e9092ce0a5035939c47e900c4235a447796a426713e1bd269a13493"
z = bytes.fromhex("d1d49a515250dbceb9f6e3fcc1c7d5306918964b21ddb22207e03e57f0600da8")
ek, dk = INTERNAL_MLKEM_KeyGen(d,z, MLKEM768)
# assert DKPKE == dk.hex(), "Derived DKPKE does not match expected value"
print(f"{'dkPKE':<15} | {DKPKE[:27]}... | {dk.hex()[:27]} ...")

expected_PolyCBD_e_hat= bytes.fromhex("000d00011000000dd0000dd00000000110000110000100d0011000010000000d000100d0001d00ff0c00ff0c00002000000000020000012000000000000000000d00011000000000000000000dd000100000000001f0cf000dd0002d0001f0cf0000d0000d00010000ff0cd0001d00010000000dd00200d00100d00020000100d0010000011000000000000000000d00000000000d000000000000d0000dd0001000002000001d000000d00100d0000d00010000002d00000dd0000d00000d00010000000d00ff2c00000d00010000ff0c000100d00000d00000d0000000000dd0001d000200000000d0000dd00000d00000d0010000ff2c000000d000000000f0cf0000000000d00100d000f0cf0000d0001000000000001d000000000100d0000d00ff0cd00000d000f0cf0100000100d0001d000010000010000100d0021000021000010000000000000d000010000110000000d00200d0ff0cd0ff0c00000d0000000000100000100000fdcf0010000110000100000000d0021000020000010000000dd0000dd00000d0000dd0011000000000000000010000002d000000d00100000010000000d00200000000000000d00000d000fdcf0200000000d00000d0000000002000ff0cd0001000002000001d000000000000d0001000000d00000000010000002000001d0000200000100001000000f0cf000dd001100002f0cf01f0cf001000000000002d00000000021000011000000dd000000000000001f0cf0000d0010000001d000010000200d0010000000dd0020000011000011000000d00000d000100000100d00200000000d0000d0000fdcf002d00000dd00000d00200000000d0011000001d00001000ff0c00000000ff1c00ff0c00000000002d00000dd0000d00001d00021000001d000000d0000d000100d0000d000200d0000dd0002d00000d00010000000d00010000000d0000000000000000100000f0cf0100d0000000ff1c00000000001000000d000100000000d00100d0ff1c000100000000d0000d0000f0cf0100d0020000000d000000000010000100d000100001f0cf0000d0000dd00100000100d0ff1c00000d000000000000d0000dd00100000100d0000d00000d0001000000100000f0cf0000000110000000d0002d00001000000d000000000000000000d0002d000000d0000d000100000100000000000000000000d00000d0001d00001000000000001000002d00001d00ff0c00010000001000011000ff0c00002d000000000000000110000100000100d0001000000000011000001000000d00000dd0000dd0001d000000d00100d0001000000d0000000001f0cf001d000000000000000000d00100d00100d0000000020000000000000000001d000010000010000000d0001d00001000011000001000000dd001f0cf0100000000d00110000110000120000000d0001d000000000200d0000000000d0000000000fdcf0100000000000120000110000000d00000d00110000110000000000020000000d0001000002d00020000010000010000011000010000012000ff1c00000dd0000d000100000100d0001d00000000000d00011000010000")
e_hat = SamplePolyCBD_eta(PRF_eta(2, sigma, bytes([3])), 2)
NTT_e_hat = NTT(e_hat)
expected_NTT_e_hat = bytes.fromhex("c64791062736bb66327cb057d81a1f1c839cff7699d58a5d9b90858bb01228065ae232c4f2f0a46bb50d77dac7ab6402da4c1c9166acf79b61eb816a497a1b6a70992b8aa07a63477bab90a0319ea7fc5a77b7b800c4785b3522ede5835eb360fdf7cfebfc2e0c1c0cca60c72e9749cb8cbaee86a4ad5509d29178bf68cb65e59760a3a543460784346ee64aceb32c348613874ae99256163fc208be9417a8dbe389de1388e7ba4c945a8bcedbb97804a8bc9863f613cd39d6cf5dc280bb410e393b9da6ba30e065c17d979a4e563d8eb12c7f668c39aa448af32a87266927694a1f70b28e1a7b88568001bc85dd5c4777b48bc1b1655377a6aed743317527ef273ee7352b8e7b58ca237ca3f9aa1c538a986658ffda8493b1993d201ba1c68a3e856c8ed93f0407c116992aa07b86e89b7b829638e3f86853c1cac3ba25021856be63613aba612ec523b3315c74633c58d7483461cea937bed9da919b728debd144288461b795af50128dfacc5e0e6c4f8430bcbe26c3e4dcb3201a4b000a4c47496fac612ff0219b28b24978175d7c092dd752789ed20feed1cd29e41ba1e99a601ace5f9054c8933ed3c94960906adec66645842bad0b01a7618ae3b48d51d36e4eda101020a635c13ebc4825fe55000a5a6a52c026ab5b7138b6ab00c19d6738b2b8023007e91feb813d38515dfda85a8624858a3529b9bc46d80b3d591b8b0cd31b5bf63ca29b89a180594f8c8227da4844e07d82c20011b718ffb156b5a4bf9971c627032cf7d2a860950f8a1074886762174c6197b7c7876c90d7123d153470177b96f70430c567b3d818337d6a863dc5af805a7921793d28848bf1e5789cf76bbc286a1c2679aa8bb810b90d588487a7372819c11c1c73888f0829cff1bcf2129cff9ba55b4aa5a7ac5e29797c3b3c1a2c73bef50540ec4b8e835c33bedc57665a124435a03ac36ec7711c7648bde7c75cd0f6b8a5eb645d646a0d868ce9f8048e138d30238b71d05e2fb7898632b9d48842882192589272f2176c6f46557baa676d8aa4be981e8d843c751334a38c56023a3fc406c013a08efb719c8a2ab0279abad6154989067c57b5941b11af97b436fe901b1f416c24cc1395f13ea7a02981e091e103234dbc81ec044d526711d94012b23a22f3e90f7e098bf2f4277e306429eab80edc7fe7d10229807d2e05a4c19c51bfe392bb76898f68c3ff629b913639c37253450c8b02ebbd19f0592d101947040e3bd2354a1b0f6d27b4bd099f383b3ea7a554347a1bd082a9dbda9ef5acc3b40a380e769d9f2814cfc74ee9747a0186a6bdc57435d168f3ba0f3b05aa78158719e42be3c581fac8936d3810fe235e63810b0609b85b7590e4d3708b86c2720ab83cc8b811e4383872a9695b5f578a36ad211c46cc1852912a16937f14d54450f322d3425b0ed8a566825bea635bd17bbe72221fa39a292897b99af5126cf5bd8077bb2703b2c7e120077a6b25683223b90727b808da2048732c5f94a4a536a518b7d374a893916b1058bd141162695d38d69ead38a490d48324b406699b8ca263beffa201f48a071bc91613238094c06d99c18c45d77b94b9b343ebc2de50c3039c1aa9534588e083")
# assert ByteEncode_d(NTT_e_hat,12) == expected_NTT_e_hat , "NTT_e_hat output does not match expected output"
print(f"{'NTT_e_hat[0]':<15} | {expected_NTT_e_hat.hex()[:27]}... | {ByteEncode_d(NTT_e_hat,12).hex()[:27]} ...")
assert ek_vector == ek , "ek_vector does not match ek"
print(f"{'ekPKE':<15} | {ek_vector.hex()[:27]}... | {ek.hex()[:27]} ...")

c_nist = bytes.fromhex("afb72488670b7d47769ee04d7479303a40b8b9d395eccdae13519e11f68df02993fa4fd89727963aecfaebdc3e9885815453be1c92e3d8eb8595d7e044ce8ad0b11765354a00729648fc38ffeaea30faf201f760c830c06300d0b602b764c903e4af7f0060ff4b21231e6142e12d11dac0d68ce4c5a65db1d9af1d9ecfebc8b4b10e5be9ac8525937e0da1366a23d6cd9441c52087dc2bf9cef4ea55371b0e00172310ed6225296269011ca3b8e402b2cdc859196f48ef89d7c82f78250960d1e384c73045f914bc8f16fbbb53ac6bb33bb9658944f78b0e708204177cda7fd92bac79211cc691fb06b37f19a5b4728d5e44bf1393167e61d7a46a2d092eb5f8e155ef3d4ee2beae490bb97044971e90c055b6f829f0434366c03ef20d99db1d86aa1e94bb33550a1534075d2727c08a9e0671d7029b0607471a3b5230d2308006bd48533a2d34ee1a4e2badd2e29a7c76c83984fa0aadb9954c99a1258faecb5ac9304619c8ff6003510ea38a720006ce7b96ae58e668b90cd310c05a6d3be3a3f1ca5749596919811fbbc324bbd2025b680e4e5f595e1e83865f05494415a0c979107c5e880133526cb60b82314b6bfe0d7a2d4be6e936fa9d9fe64e16fcce1207bff6e28fb3a7f2fa0a019745cd0d53a44553a19cf96be357a4cfcde068389f47347b7b977f73755ccf05afead81b488fce6f2964def2b6d1a59557ba59ad71af9c2900b63836ff669e8de1438b929edf802d59f1c4b76f65d04f7ceb8f9e36f87d4d8391007e1990191938e14856ed4f84f63d38b9b655189d7f76ef508204af931a75e1fd011ff899f13d0bfff972cb1a679e2f073587dfdf3b8a6457fe897fcefd1ff8956bf3d7ad1355611ddd9002af05ba9f3a66346ab26b015035be428f3146227be21447c9dc002d7ea371f2e98a156a1f2f2205d43961fdadd1939763ee054d07ca1a6f1bae0f102d207a9f11039d5b6041d9e92071d72f755c57f3525d0e1e954a1e465b5406fd5af583aca7e48cdc5a9c266ddae6f3c124c4a9698aed2d69ce2c4d25485d70480fdd0da18a4f6d42aeaf97baa4858b440602582a634f96938eadb63f9cc74ac1e54fd0772a3ff66fa92dbdb6a4ec7c7923d0ee6fb5f9bc300701ac6c2f920d7e23188ed6798cf47f0df850f40a471cc8840ecbaf7834bb5b78b3ace2bd0a5e9dee5fafda8d73388671abe30574ff6e0478e3d1138d50289cd8254129a9cc3a7ac758428d73cf58ed848abb192c70b842809b141b4e82a899bcbd4d281f15443287bc3eec2330367688da43f24e30f3ad10f435508b461608b18d3baead359c35dd61d29ff574a100686c8b4521a82a10588cc11c91ff18bcf20b6c1cdfc323b09f33d00972b0a447ddd2a1d95c32efcc9d2624200aa3b049f382e8a987a76fab5bdd808988a7c5a2dc939f2b34fba7db71848b1caa6a20424f2136bc5d0f8c04639fc818ce2ad94bfc072891451675c6566cd668b6ae5eff71a1ff5ecf5769870c182b31c0f79e31e044eec7f9feea416e410b")
c = KPKE_Encrypt(ek, m_test, r_test, k=3, eta1=2, eta2=2, du=MLKEM768.du, dv=MLKEM768.dv)
assert c == c_nist, "Encrypted ciphertext does not match expected ciphertext"
print(f"{'c (ciphertext)':<15} | {c_nist.hex()[:27]}... | {c.hex()[:27]} ...")

m = KPKE_Decrypt(dk, c, k=3, du=MLKEM768.du, dv=MLKEM768.dv) 
assert m == m_test, "Decrypted message does not match expected message"
print(f"{'m':<15} | {m.hex()[:27]}... | {m_test.hex()[:27]} ...")

K, c = INTERNAL_MLKEM_Encaps(ek, m_test, MLKEM768)
assert c == c_nist, "Encapsulated ciphertext does not match expected ciphertext"
print(f"{'c (Encaps)':<15} | {c_nist.hex()[:27]}... | {c.hex()[:27]} ...")

print(f"{'K (Encaps)':<15} | {K.hex()[:27]}... | {K_test.hex()[:27]} ...")
K_prime = INTERNAL_MLKEM_Decaps(dk, c, MLKEM768)
assert K_prime == K_test, "Decapsulated key does not match expected key"
print(f"{'K_prime (Decaps)':<15} | {K_prime.hex()[:27]}... | {K_test.hex()[:27]} ...")



